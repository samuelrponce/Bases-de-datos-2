
CREATE OR REPLACE PROCEDURE SP_INSERT_TOMAS(HORA TIMESTAMP, FECHA DATE, ANIMAL_ID VARCHAR2,
DIETA_ID VARCHAR2, MSJ_ERROR OUT VARCHAR2, MSJ_EXITO OUT VARCHAR2)
IS
  CANTIDAD_REGISTROS NUMBER;
  CANTIDAD_REGISTROS2 NUMBER;
  VAL_MAX_TOMA_ID NUMBER;
BEGIN
SELECT (MAX(TOMAID)+1) INTO VAL_MAX_TOMA_ID FROM TOMAS;
  SELECT COUNT(*) INTO CANTIDAD_REGISTROS FROM DIETA WHERE DIETAID=DIETA_ID;
  SELECT COUNT(*) INTO CANTIDAD_REGISTROS2 FROM ANIMALES WHERE ANIMALID=ANIMAL_ID;
  IF (CANTIDAD_REGISTROS=1) THEN
    IF(CANTIDAD_REGISTROS2=1) THEN
      INSERT INTO TOMAS VALUES (VAL_MAX_TOMA_ID,HORA,FECHA,ANIMAL_ID,DIETA_ID);
      COMMIT;
  
  MSJ_EXITO:='LA INSERCION DE LA TOMA FUE EXITOSA';
    END IF;
  END IF;
  EXCEPTION 
    WHEN OTHERS THEN
      MSJ_ERROR:=SQLERRM;
END;

DECLARE 
  MSJ_ERROR VARCHAR2(500);
  MSJ_EXITO VARCHAR2(500);
BEGIN
  SP_INSERT_TOMAS(TO_DATE('2003-11-16 12:00:00','YYYY-MM-DD HH24:MI:SS'),TO_DATE('2003-11-28','YYYY-MM-DD'),'A-01-D1','134134',MSJ_ERROR,MSJ_EXITO);
  DBMS_OUTPUT.PUT_LINE(MSJ_EXITO||' '||MSJ_ERROR);
END;

SET SERVEROUTPUT ON;
