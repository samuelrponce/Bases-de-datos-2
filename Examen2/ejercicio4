/*Ejercicio4*/
------------------------------------------------------------------------------------------

CREATE OR REPLACE PROCEDURE SP_PROP_20181004394 (CDATOS_PROPIEDADES IN OUT SYS_REFCURSOR)
IS 
  PRECIO_PROM NUMBER;
BEGIN
  SELECT AVG(PRICE) INTO PRECIO_PROM FROM PROPERTYS WHERE PROPERTY_TYPE='Apartment';

  OPEN CDATOS_PROPIEDADES FOR SELECT ID_PROPERTY, NIF_PROPERTY, ADDRESS_PROP, GEOGRAPHICAL_COORDS, BUILDING_DATE, PUBLICATION_DATE_SALE, PROPERTY_TYPE, ID_SUP, PRICE
  FROM PROPERTYS WHERE PROPERTY_TYPE='Apartment' AND PRICE >= PRECIO_PROM ;
END;

DECLARE 
  CDATOS_PROPIEDADES SYS_REFCURSOR;
  DATOS PROPERTYS%ROWTYPE;
BEGIN
  SP_PROP_20181004394(CDATOS_PROPIEDADES);
  IF(CDATOS_PROPIEDADES%NOTFOUND) THEN
    DBMS_OUTPUT.PUT_LINE('SIN REGISTRO');
  END IF;
  LOOP
    FETCH CDATOS_PROPIEDADES INTO DATOS;
    EXIT WHEN CDATOS_PROPIEDADES%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE('el id de la propiedad es: '||DATOS.ID_PROPERTY);
    DBMS_OUTPUT.PUT_LINE('l nif propiedad es: '||DATOS.NIF_PROPERTY);
    DBMS_OUTPUT.PUT_LINE('la direccion de la propiedad ees: '||DATOS.ADDRESS_PROP);
    DBMS_OUTPUT.PUT_LINE('las coordenadas geograficas de la propiedad es: '||DATOS.GEOGRAPHICAL_COORDS);
    DBMS_OUTPUT.PUT_LINE('la fecha de cronstuccion es: '||DATOS.BUILDING_DATE);
    DBMS_OUTPUT.PUT_LINE('la fecha de publicacion de venta es: '||DATOS.PUBLICATION_DATE_SALE);
    DBMS_OUTPUT.PUT_LINE('el tipo de propiedad es: '||DATOS.PROPERTY_TYPE);
    DBMS_OUTPUT.PUT_LINE('el id sup es: '||DATOS.ID_SUP);
    DBMS_OUTPUT.PUT_LINE('el precio es: '||DATOS.PRICE);
  END LOOP;
END;
